<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"> <!-- 인코딩 설정 -->
    <title>WebSocket STOMP 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        .member {
            margin-bottom: 10px;
        }
        .member input {
            margin-right: 5px;
        }
        .remove-member {
            color: red;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
<h2>채팅 테스트</h2>

<!-- 채팅방 생성 섹션 -->
<div>
    <h3>채팅방 생성</h3>
    <input type="text" id="chatRoomName" placeholder="채팅방 이름" />

    <!-- 멤버 추가/삭제 버튼 -->
    <div id="membersContainer">
        <div class="member">
            <input type="number" class="member-id" placeholder="멤버 ID" />
            <input type="text" class="member-nickname" placeholder="멤버 닉네임" />
            <span class="remove-member" onclick="removeMember(this)">✖</span>
        </div>
    </div>
    <button onclick="addMember()">멤버 추가</button>
    <button onclick="createChatRoom()">채팅방 생성</button>
    <div id="createdChatRoom"></div>
</div>

<!-- 채팅방 구독 섹션 -->
<div>
    <h3>채팅방 구독</h3>
    <input type="number" id="subscribeRoomId" placeholder="채팅방 ID" />
    <button onclick="subscribeChatRoom()">구독</button>
</div>

<!-- 메시지 보내기 섹션 -->
<div>
    <h3>메시지 보내기</h3>
    <!-- sendRoomId 필드 제거 -->
    <input type="text" id="sender" placeholder="보내는 사람" />
    <input type="number" id="memberId" placeholder="멤버 ID" />
    <input type="text" id="message" placeholder="메시지" />
    <button onclick="sendMessage()">보내기</button>
</div>

<!-- 채팅 영역 -->
<div>
    <h3>채팅 영역</h3>
    <div id="chatArea" style="border:1px solid #000; height:300px; overflow:auto;"></div>
</div>

<script>
    let stompClient = null;
    let connected = false; // 연결 상태 추적 변수
    let subscribedRoomId = null;

    // 멤버 추가 함수
    function addMember() {
        const membersContainer = document.getElementById('membersContainer');
        const memberDiv = document.createElement('div');
        memberDiv.className = 'member';
        memberDiv.innerHTML = `
                <input type="number" class="member-id" placeholder="멤버 ID" />
                <input type="text" class="member-nickname" placeholder="멤버 닉네임" />
                <span class="remove-member" onclick="removeMember(this)">✖</span>
            `;
        membersContainer.appendChild(memberDiv);
    }

    // 멤버 제거 함수
    function removeMember(element) {
        const memberDiv = element.parentElement;
        memberDiv.remove();
    }

    // 채팅방 생성 함수
    function createChatRoom() {
        const name = document.getElementById('chatRoomName').value.trim();
        if (!name) {
            alert('채팅방 이름을 입력하세요.');
            return;
        }

        // 멤버 정보 수집
        const members = document.querySelectorAll('.member');
        const membersInfo = {};
        let valid = true;

        members.forEach((member, index) => {
            const idInput = member.querySelector('.member-id');
            const nicknameInput = member.querySelector('.member-nickname');
            const id = idInput.value.trim();
            const nickname = nicknameInput.value.trim();

            if (!id || !nickname) {
                alert(`멤버 ${index + 1}의 ID와 닉네임을 모두 입력하세요.`);
                valid = false;
                return;
            }

            membersInfo[id] = nickname;
        });

        if (!valid) return;

        const chatInitiate = {
            roomName: name,
            membersInfo: membersInfo
        };

        fetch('/api/v1/chatRoom/initiate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(chatInitiate)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('채팅방 생성 실패');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('createdChatRoom').innerText = `채팅방 생성됨: ID=${data.chatRoomId}`;
                // 필요 시 자동 구독
                // subscribeChatRoomWithId(data.roomId);
            })
            .catch(error => console.error('오류:', error));
    }

    // 채팅방 구독 함수
    function subscribeChatRoom() {
        const roomId = document.getElementById('subscribeRoomId').value.trim();
        if (!roomId) {
            alert('구독할 채팅방 ID를 입력하세요.');
            return;
        }
        subscribedRoomId = roomId;

        // WebSocket 연결이 아직 안 되어 있다면 연결 설정
        if (!stompClient || !connected) {
            const socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                connected = true;
                console.log('연결됨: ' + frame);
                stompClient.subscribe(`/topic/chat/${roomId}`, function(message) {  //구독 url
                    const chat = JSON.parse(message.body);
                    displayMessage(chat.nickname, chat.content);
                });
                alert(`채팅방 ID ${roomId}을(를) 구독했습니다.`);
            }, function(error) {
                console.error('연결 실패:', error);
                alert('WebSocket 연결에 실패했습니다.');
            });
        } else {
            // 이미 연결되어 있다면 새로운 채팅방 구독
            stompClient.subscribe(`/topic/chat/${roomId}`, function(message) {
                const chat = JSON.parse(message.body);
                displayMessage(chat.nickname, chat.content);
            });
            alert(`채팅방 ID ${roomId}을(를) 구독했습니다.`);
        }
    }

    // 메시지 보내기 함수
    function sendMessage() {
        if (!connected) {
            alert('WebSocket에 연결되지 않았습니다. 먼저 채팅방을 구독하세요.');
            return;
        }

        if (!subscribedRoomId) {
            alert('먼저 채팅방을 구독하세요.');
            return;
        }

        const nickname = document.getElementById('sender').value.trim();
        const memberId = document.getElementById('memberId').value.trim();
        const content = document.getElementById('message').value.trim();

        if (!nickname || !memberId || !content) {
            alert('모든 필드를 입력하세요.');
            return;
        }

        const chatMessage = {
            chatRoomId: parseInt(subscribedRoomId),
            nickname: nickname,
            memberId: parseInt(memberId),
            content: content
        };

        stompClient.send("/app/chat/message", {}, JSON.stringify(chatMessage))
            .then(() => {
                document.getElementById('message').value = '';
            })
            .catch(error => {
                console.error('메시지 전송 실패:', error);
                alert('메시지 전송에 실패했습니다. 관리자에게 문의하세요.');
            });
    }


    // 메시지 표시 함수
    function displayMessage(nickname, message) {
        const chatArea = document.getElementById('chatArea');
        const msgElement = document.createElement('p');
        msgElement.textContent = `${nickname}: ${message}`;
        chatArea.appendChild(msgElement);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
</script>
</body>
</html>
